# 数据是如何转发的
- URL: https://www.kawabangga.com/posts/6919
- Added At: 2025-04-05 03:40:47
- [Link To Text](2025-04-05-数据是如何转发的_raw.md)

## Summary
**摘要**：
本文是关于网络基础知识的科普，重点介绍了网络转发的概念，强调所有转发本质上都是二层转发。文章解释了数据包在网络设备中的传输过程，交换机仅根据MAC地址表转发，路由器则修改数据包的目标MAC地址以实现跨子网转发。同时，文章还阐述了`traceroute`的工作原理，通过发送不同TTL值的ICMP包来追踪数据包经过的路径，并解释了为什么`traceroute`的ICMP错误信息不是直接从目标设备发回源IP。此外，文章还介绍了“流”的概念，即属于同一个数据流的数据包在IP层会通过哈希算法选择相同的路径，以尽量保证数据包的顺序，减少TCP协议的负担，虽然TCP可以纠正乱序，但IP层尽量保证数据包按序到达可以提升效率。最后，作者还分享了“计算机网络实用技术”系列文章的目录，旨在通过实战案例分享网络抓包分析等实用技术。

**要点总结**：

1.  **所有转发都是二层转发**：数据包在网络中的传输依赖于二层协议。即使是涉及到三层路由的转发，最终也是通过修改二层头部信息（如目标MAC地址）来实现的。路由器在转发IP包时，会根据目标IP查找下一跳IP，并获取下一跳IP对应的MAC地址，然后将数据包的目标MAC地址修改为下一跳的MAC地址进行转发。

2.  **Traceroute 的原理**：`traceroute` 通过发送具有递增TTL（Time To Live）值的ICMP包来追踪数据包经过的网络路径。当数据包的TTL减为0时，路由器会丢弃该数据包并返回一个ICMP time exceed错误信息，其中包含该路由器的IP地址，通过这种方式，`traceroute` 能够逐步发现到达目标地址所经过的所有路由器。

3.  **流(flow)的概念**：在网络中，“流”指的是具有相同源IP、源端口、目标IP和目标端口的数据包序列。网络设备会尽量保证属于同一个“流”的所有数据包通过相同的路径，这是通过在IP层使用哈希算法来实现的，该算法基于流的特征（如源IP、目标IP等）为每个流选择一个固定的下一跳。

4.  **IP层保证数据包顺序的重要性**：虽然TCP协议可以保证数据包的顺序，但是IP层尽量保证数据包的按序到达可以减少TCP的负担，提高网络传输效率。如果数据包在IP层就发生乱序，TCP需要消耗更多的资源来进行重排序，甚至可能错误地判断网络拥塞而降低发送速度，因此，IP层按序发送可以看作是对TCP的一种优化。

