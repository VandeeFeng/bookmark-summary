# Build a Tiny Certificate Authority For Your Homelab
- URL: https://smallstep.com/blog/build-a-tiny-ca-with-raspberry-pi-yubikey/
- Added At: 2025-01-22 04:50:04
- [Link To Text](2025-01-22-build-a-tiny-certificate-authority-for-your-homelab_raw.md)

## Summary
**摘要**：
本文提供了一个构建小型证书机构（CA）的指南，以防用户在家庭实验室中随时部署安全的TLS证书。通过这个指南，用户可以利用体积较小的硬件设备，如Raspberry Pi和YubiKey，构建一个自己的证书签发环境。互联网上的证书是实现全天候、安全的服务如Web、电子邮件和SFTP等保障的基础。此外，内部网络也正逐渐从不加密的可能安全区域转变为需要证书的通信方式。

构建流程首先从系统设置开始，包括安装必要的软件、配置网络环境，确保部分设备能快速识别到本地网络中其他需要CA认证的设备。通过安装`ykman`和`Go`软件，以及利用`step-ca`和`step`开源工具，用户可以将CA服务器部署于Raspberry Pi上，并与YubiKey进行安全集成，为其他SAM及其他设备生成和管理TLS证书。

系统随后定调为自动启动，确保在插入YubiKey时CA自动运行，但在拔出时自动停止。这部分利用了`systemd`的特性来处理设备的元数据识别与自动化服务管理。

为了避免安全风险，特别是未经授权的SSH访问，文章结尾部分还针对增强的防火墙配置以及禁用对Raspberry Pi的直接SSH连接提出了建议。考虑到对证书的自动更新需求，文章分享了通过其他认证工具如Certbot和LEGO CLI等进行证书分发与续期的实用方法。

总的来说，本文提供了一个包括硬件选型、软件安装及配置、自动化实现步骤，最后还有专用用途的总结，旨在教导用户如何构建一个高效、安全且经济的内部CA环境，满足在家庭实验室或办公室网络中确保数据传输安全的需求。

**要点总结**：
1. **资源准备**：用户需要选择和准备必要的硬件（例如Raspberry Pi 4、YubiKey、USB记忆棒或第二把YubiKey）以及相关软件（如Ubuntu操作系统镜像、YoKey Manager、Go、Smallstep的`step-ca`和`step`工具）。这些是构建小型CA的基础组件。
2. **系统配置**：指导用户在Raspberry Pi上安装必要的软件，包括重启密码设置、改变主机名、设备的位置同步、DNS解析等，确保系统集成顺利。使用 udev 规则识别和访问YubiKey以建立自动控制流程。使用 systemd 服务使CA在启动时运行且在 YubiKey 插入和拔出时保持活动状态。
3. **CA安装与基础实践**：通过下载并分步构建`step-ca`及其依赖，用户将能够管理并启动 CA。构建的安全 CA 将用于生成 SSL/TLS 和 SSH 密钥对，本进程涉及到证书签发与备份等步骤。
4. **防火墙调教与SSH限制**：指引用户进行防火墙设置，确保只有 SSL 的相应端口（443）开放，以降低潜在的攻击风险。同时，禁止SSH访问以避免未经授权的系统控制，只保留硬件唤醒通道（键盘和显示器）进行维护及管理。
5. **证书使用与自动化**：解释了一般证书用法，提供了通过 SSH 客户端下载证书、安装CA根证书到本地存储的指南，并举例说明通过使用ACME协议与诸如Certbot 或LEGO CLI工具在内的客户端自动获取和更新SSL/TLS及SSH证书。同时强调，基于证书存在24小时的生命周期，设置自动化脚本定期更新证书成为必须操作。
