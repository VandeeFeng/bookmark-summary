# Relocation generation in assemblers
- URL: https://maskray.me/blog/2025-03-16-relocation-generation-in-assemblers
- Added At: 2025-03-17 02:42:47
- [Link To Text](2025-03-17-relocation-generation-in-assemblers_raw.md)

## Summary
**摘要**：
本文探讨了GNU汇编器和LLVM集成汇编器如何生成重定位，这是生成可重定位文件的关键步骤。重定位用于识别指令或数据中在汇编期间无法完全确定的部分，因为它们依赖于最终的内存布局，这只能在链接时或加载时确定。这些部分本质上是占位符，将在链接过程中被填充。文章详细讲解了汇编器生成重定位的过程，包括解析阶段、节布局阶段和重定位决策阶段。在解析阶段，汇编器构建包含指令和指令的节片段，并将无法在解析时解析的表达式转换为“修复”。在节布局阶段，汇编器通过为片段分配精确的偏移量来安排每个节。然后，汇编器评估每个修复，以确定是直接解析它还是需要重定位条目。文章还讨论了重定位说明符，它指导汇编器如何将表达式解析和编码到指令中，并探讨了不同架构中使用的各种重定位说明符语法。此外，还介绍了TLS符号和组合重定位。最后，文章深入探讨了GNU汇编器和LLVM的内部结构，展示了它们如何处理修复和重定位表达式。

**要点总结**：

1.  重定位是汇编器生成可重定位文件的关键步骤，用于处理在汇编时无法确定地址的符号引用，这些引用需要在链接或加载时进行填充。主要通过对表达式进行计算，来确定是否需要生成重定位条目。

2.  汇编器通过解析阶段、节布局阶段和重定位决策阶段生成重定位。解析阶段识别符号引用并创建“修复”，节布局阶段确定片段偏移，重定位决策阶段评估修复并生成重定位条目。

3.  重定位表达式通常包含重定位说明符、加数符号、可选的减数符号和常量偏移量。汇编器会尝试将修复转换为可重定位的表达式，如果表达式无法立即解析为常量，则生成重定位条目.

4.  重定位说明符用于指导汇编器如何解析表达式并将其编码为指令，指定寻址方式（绝对地址或PC相对地址）、符号的特定部分（如高位或低位）以及是否使用PLT或GOT条目。

5.  GNU汇编器和LLVM在内部表示修复和重定位表达式的方式有所不同。GNU汇编器使用`struct fixup`，而LLVM则将修复和可重定位表达式分别编码，使用`MCValue`类来表示可重定位的表达式。

