# Build a Container Image from Scratch
- URL: https://danishpraka.sh/posts/build-a-container-image-from-scratch/
- Added At: 2025-03-21 09:00:12
- [Link To Text](2025-03-21-build-a-container-image-from-scratch_raw.md)

## Summary
**摘要**：
本文旨在深入剖析容器镜像的内部构造，通过从零开始构建一个容器镜像，解答关于镜像层、文件系统组合以及多平台镜像等问题。文章首先介绍了OCI（开放容器倡议）规范，该规范统一了容器镜像的标准。一个OCI镜像由四部分组成：层（layer），配置（config），清单（manifest）和索引（index）。文章详细解释了每一部分的作用和创建方法。层是镜像的构建块，代表镜像内的文件系统变更集，通过将多个层叠加来构建最终的文件系统。配置定义了容器的运行方式，如环境变量、入口点等。清单则用于定位镜像的层和配置文件。索引则指向不同架构和操作系统的多个镜像清单。文章还强调了内容寻址的重要性，通过将组件的哈希值作为文件名，实现数据去重和完整性校验。最后，文章通过一个“hello world”示例，展示了如何从头构建一个基于scratch和alpine的容器镜像，并使用podman进行加载和运行，验证了构建过程的正确性，从而帮助读者更深入地理解容器镜像的内部机制。

**要点总结**：

1.  **OCI镜像的组成**：一个OCI镜像由四个核心组件构成：层（layer）、配置（config）、清单（manifest）和索引（index），理解这些组件是构建和管理容器镜像的基础。其中，层（layer）代表镜像包含的内容，是文件系统的变更集合；配置（config）定义了容器的运行方式，例如环境变量和入口点；清单（manifest）用于定位镜像的层和配置文件；索引（index）则用于指向不同架构和操作系统的多个镜像清单。
2.  **层（layer）的创建与文件系统构建**：层是容器镜像的基础构建块，通过创建文件系统变更集（changeset）来构建。变更集包含已添加、修改和删除的文件，并通过`.wh`文件来标记删除的文件。容器引擎通过将多个层叠加在一起来创建最终的文件系统。每一层都可以被认为是对先前文件系统状态的修改，最终的容器文件系统是所有这些修改的累积结果。
3.  **内容寻址（Content Addressability）**：OCI镜像使用内容寻址来提高效率和确保完整性。这意味着镜像的组件通过其内容的哈希值（如SHA256）来唯一标识，而不是通过文件名或路径。这种方法有助于数据去重、层共享，并确保数据完整性，因为任何对组件的修改都会导致哈希值改变。
4.  **清单（manifest）和索引（index）的作用**：清单文件用于定位镜像的各个层和配置文件，它包含了每个组件的哈希值（digest）和大小等元数据。索引文件则用于指向不同架构或操作系统的多个镜像清单，使得可以在一个镜像仓库中存储和分发多个平台的镜像变体。
5.  **从scratch和alpine构建镜像的差异**：从scratch构建镜像意味着从一个空的文件系统开始，需要包含所有必要的依赖和文件。而基于如alpine这样的基础镜像构建，则可以利用已有的文件系统和工具，减少了构建过程中的工作量。文章通过对比两种构建方法，展示了如何添加新的层，并相应地更新配置文件和清单文件。
