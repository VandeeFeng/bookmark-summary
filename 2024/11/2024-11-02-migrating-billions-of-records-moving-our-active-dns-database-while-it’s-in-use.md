# Migrating billions of records: moving our active DNS database while it’s in use
- URL: https://blog.cloudflare.com/migrating-billions-of-records-moving-our-active-dns-database-while-in-use
- Added At: 2024-11-02 09:30:34
- [Link To Text](2024-11-02-migrating-billions-of-records-moving-our-active-dns-database-while-it’s-in-use_raw.md)

## Summary
**摘要**：
本文讨论了Cloudflare进行DNS数据迁移的详细流程，涉及DNS数据管理、数据库架构调整与优化、服务数据分离、新API接口构建和数据同步维持等多个方面。考虑迁移的主要原因是原数据存储系统cfdb出现了资源紧张，网络请求高峰期导致其它服务的数据库性能下降。系统升级和优化需求促使DNS团队独立于cfdb，移动DNS记录数据至另一个数据库集群。

文章阐述了从起始规划到筹备阶段、迁移执行、后迁移优化的全貌，包括服务数据的分隔、创建请求锁定系统、提高API的写操作控制，以及采用新的gRPC接口引入数据安全性、资源限制和性能提升等措施。文章详细的说明了迁移过程中各步骤以及最终目标，突出展示了此迁移过程的复杂性与系统调整的必要性。

**要点总结**：
1. **原因与规划**：Cloudflare 的 DNS 数据存储容量过大，占据了 cfdb 约40%的存储，对系统性能构成了压力。DNS 团队决定迁移 DNS 数据，独立于 cfdb 至另一数据库集群，进行资源优化与性能提升。
2. **基础系统与旧问题**：初期依赖单一的 PostgreSQL cfdb，负责存储 zone 和账户信息及相关服务数据。随着 Cloudflare 的扩展，数据迁移涉及多个服务，以及与数据紧密相关的 zone 和 DNS 记录的处理，带来了难以直接调整和控制的复杂性。原始数据库缺乏对访问数据控制和性能优化的机制。
3. **新 API 接口**：创建基于 gRPC 的内部 DNS 记录 API，以简化数据变更，减少协同成本，增加数据访问逻辑和审计操作的灵活性。接口设计采取了API内部数据修改策略，减少对外部系统的依赖，同时优化数据访问和控制。
4. **迁移执行**：采用基于数据库事务周期性操作的数据同步策略（每个数据库读取-复制-应用更新阶段），以几秒内完成 DNS 数据迁移过程。借助多服务的转换过程确保在仅变更API而不影响其他系统的情况下完成数据移植工作。
5. **优化后体系**：成功切换至新数据库集群后，实现了 DNS 记录服务性能的显著改善，包括API请求量的增加、CPU资源负载的分配优化、以及服务开销和延时的降低。新体系支持更具弹性的性能提升和更为严格的资源管理和安全性控制。
6. **持续改进与工作展望**：迁移是持续优化工程的一部分，Cloudflare还在探索更多关于 DNS 和其它服务架构的优化提升，旨在构建更稳健、高效率的互联云环境和应用程序环境。

文章以详实的方法论，从不同角度展现了 Cloudflare DNS 数据迁移项目的实施逻辑、技术挑战与效益实现，为读者提供了一套系统化管理和优化数据库架构的经验借鉴，展现了技术团队在面对大规模数据挑战时的策略思考与实际行动。
